# 14 브로드캐스트 리시버 컴포넌트
## 14-1 브로드캐스트 리시버 이해하기
- *브로드캐스트 리시버(`broadcast receiver`)* : 이벤트(사용자 이벤트가 아닌 시스템의 특정 상황) 모델로 실행되는 컴포넌트
  - 안드로이드의 컴포넌트이므로 인텐트를 시스템에 전달함으로써 실행함

- 브로드캐스트 리시버 만들기
  ```Kotlin
  class MyReceiver : BroadcastReceiver() {
    override fun onReceive(context: Context, intent: Intent) {
    }
  }
  ```
  - 방법 1 : manifest 파일에 등록
  ```Kotlin
  <receiver
    android:name=".MyReceiver"
    android:enabled="true"
    android:exported="true"></receiver>
  ```

  - 방법 2 : 동적 등록과 해제 -> 특정 액티비티나 서비스가 동작할 때만 broadcast receiver를 실행할 때
    - 리시버 객체 생성
    ```Kotlin
    val receiver = object : BroadcastReceiver() {
      override fun onReceive(context: Context?, intent: Intent?) {
      }
    }
    ```

    - 동적 등록
    ```Kotlin
    registerReceiver(receiver, IntentFilter("ACTION_RECEIVER"), RECEIVER_EXPORTED)
    ```
      - 공개상태 정보 : `RECEIVER_EXPORTED`(explicit intent에 의해 실행), `RECEIVER_NOT_EXPORTED`

    - 해제 (필요없는 경우 해제해 줌)
    ```Kotlin
    unregisterReceiver(receiver)
    ```

    - 실행
      - intent가 필요함.
      - receiver의 클래스명만 등록했을 경우 : class type reference를 사용해 explicit intent로 실행
      - intent filter를 등록했을 경우 : implicit intent로 실행
      ??? 이 부분이 잘 이해되지 않음 ???
      ```Kotlin
      val intent = Intent(this, MyReceiver::class.java)
      sendBroadcast(intent)
      ```
      - 브로드캐스트 리시버는 시스템에 해당 인텐트로 실행될 리시버가 없어도 아무 일도 일어나지 않음
      - intent를 시작한 곳에서 오류 발생하지 않음
      - 실행될 리시버가 여러 개 있으면 모두 실행됨
  
## 14-2 시스템 상태 파악하기
- *부팅 완료*
  - 안드로이드 기기의 전원을 켜면 시스템이 동작해 부팅이 시작되고 완료되면 사용자가 기기를 사용할 수 있는 상태가 됨
  - 앱에서 부팅 완료 시 특정 작업을 수행하고 싶을 때, 브로드캐스트 리시버를 만들고 매니페스트 파일에 인텐트 필터를 구성해서 등록함
  ```Kotlin
  <receiver
    android:name=".MyReceiver"
    android:enabled="true"
    android:exported="true">
    <intent-filter>
      <action android:name="android.intent.action.BOOT_COMPLETED" />
    </intent-filter>
  </reciever>
  ```
  - 리시버 실행 시 권한이 필요하므로 메니패스트에 퍼미션을 추가해야 함
    
- *화면 켬/끔*
  - 매니페스트에 등록하면 실행되지 않음
  - `registerReceiver()`를 이용해 동적으로 등록해야 함
  ```Kotlin
  receiver = object : BroadcastReceiver() {
    override fun onReceive(context: Context?, intent: Intent?) {
      when (intent?.action) {
        Intent.ACTION_SCREEN_ON -> Log.d("kkang", "screen on")
        Intent.ACTION_SCREEN_OFF -> Log.d("kkang", "screen off")
      }
    }
  }
  ```

  - 정의한 브로드캐스트 리시버 객체를 액션 문자열 정보로 구성한 인텐트 필터와 함께 `registerReceiver()`로 시스템에 등록함
  ```Kotlin
  val filter = IntentFilter(Intent.ACTION_SCREEN_ON).apply {
    addAction(Intent.ACTION_SCREEN_OFF)
  }
  registerReceiver(receiver, filter)
  ```

  - 리시버 등록 해제
  ```Kotlin
  unregisterReceiver(receiver)
  ```

- *배터리 상태*
  - 현재 기기에 전원이 공급되는지, 충전량은 얼마나 되는지
  - 안드로이드 시스템에서 배터리 상태가 변경되면 액션 문자열로 인텐트가 발생함
  ```Kotlin
  receiver = object : BroadcastReceiver() {
    override fun onReceive(context: Context?, intent: Intent?) {
      when (intent?.action) {
        Intent.ACTION_BATTERY_OKAY -> Log.d("kkang", "ACTION_BATTERY_OKAY")
        Intent.ACTION_BATTERY_LOW -> Log.d("kkang", "ACTION_BATTERY_LOW")
        Intent.ACTION_BATTERY_CHANGED -> Log.d("kkang", "ACTION_BATTERY_CHANGED")
        Intent.ACTION_BATTERY_CONNECTED -> Log.d("kkang", "ACTION_BATTERY_CONNECTED")
        Intent.ACTION_BATTERY_DISCONNECTED -> Log.d("kkang", "ACTION_BATTERY_DISCONNECTED")  
      }
    }
  }
  ```

  - 리시버 등록
  ```Kotlin
  val filter = IntentFilter(Intent.ACTION_SCREEN_ON).apply {
    addAction(Intent.ACTION_BATTERY_OKAY)
    addAction(Intent.ACTION_BATTERY_CHANGED)
    addAction(Intent.ACTION_BATTERY_CONNECTED)
    addAction(Intent.ACTION_BATTERY_DISCONNECTED)
  }
  registerReceiver(receiver, filter)
  ```

  - 시스템의 상태가 변경되지 않았지만 배터리 정보가 필요한 경우, 시스템 인텐트 없이 배터리 상태를 파악할 수 있음
  ```Kotlin
  val intentFilter = IntentFilter(Intent.ACTION_BATTERY_CHANGED)
  val batteryStatus = registerReceiver(null, intentFilter)
  ```

  ```Kotlin
  val status = batteryStatus!!.getIntExtra(BatteryManager.EXTRA_STATUS, -1)
  if (status == BatteryManager.BATTERY_STATUS_CHARGING) {
    // 전원이 공급되고 있다면
    val chargePlug = batteryStatus.getIntExtra(BatteryManager.EXTRA_PLUGGED, -1)
    when (chargePlug) {
      BatteryManager.BATTERY_PLUGGED_USB -> Log.d("kkang", "usb charge")
      BatteryManager.BATTERY_PLUGGED_AC -> Log.d("kkang", "ac charge")
   }
  } else {
    // 전원이 공급되고 있지 않다면
    Log.d("kkang", "not charging")
  }
  ```
    - USB : 저속 충전 상태
    - AC : 고속 충전 상태

  - 배터리 충전량을 알 수 있음
  ```Kotlin
  val level = batteryStatus.getIntExtra(BatteryManager.EXTRA_LEVEL, -1)
  val scale = batteryStatus.getIntExtra(BatteryManager.EXTRA_SCALE, -1)
  val batteryPct = level / scale.toFloat() * 100
  Log.d("kkang", "batteryPct : $batteryPct")
  ```
