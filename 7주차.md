# 15 서비스 컴포넌트
## 15-1 서비스 이해하기
- 서비스 : 오래 걸리는 작업을 백그라운드에서 처리할 수 있게 해주는 컴포넌트
  - 서비스에 화면을 구현하지 않음
  - 안드로이드의 컴포넌트이므로 생명주기를 시스템에서 관리함

### 서비스 생성과 실행
- 서비스 컴포넌트 생성
```Kotlin
class MyService : Service() {
  override fun onBind(intent: Intent): IBinder? {
    return null
  }
}
```

- 서비스 컴포넌트 등록
```Kotlin
<service
  android:name=".MyService"
  android:enabled="true"
  android:exported="true"></service>
```

- 서비스 실행
  - `startService()`로 실행
  ```Kotlin
  val intent = Intent(this, MyService::class.java)
  startService(intent)
  ```

  암시적 인텐트로 실행
  ```Kotlin
  val intent = Intent("ACTION_OUTER_SERVICE")
  intent.setPackage("com.example.test_outer")
  startService(intent)
  ```

  외부 앱 패키지 공개 상태 지정
  ```Kotlin
  <queries>
    <package android:name="com.example.test_outer" />
  </queries>
  ```

  서비스 종료
  ```Kotlin
  val intent = Intent(this, MyService::class.java)
  stopService(intent)
  ```

  - `bindService()`로 실행
  ServiceConnection 인터페이스 구현
  ```Kotlin
  val connection: ServiceConnection = object : ServiceConnection {
    override fun onServiceConnected(name: ComponentName?, service: IBinder?) { } // bindService() 함수로 서비스를 구동할 때 자동으로 호출됨
    override fun onServiceDisconnected(name: ComponentName?) { } // unbindService() 함수로 서비스를 종료할 때 자동으로 호출됨
  }
  ```

  서비스 실행
  ```Kotlin
  val intent = Intent(this, MyService::class.java)
  bindService(intent, connection, Context.BIND_AUTO_CREATE)
  //    intent 객체 / ServiceConnection 객체 / Int 타입의 flags
  ```
    - `Context.BIND_AUTO_CREATE` : 서비스가 실행 상태가 아니어도 객체를 생성해서 실행
    - 지정하지 않으면 인텐트가 전달돼도 서비스가 실행 상태가 아니면 동작하지 않음

  서비스 종료
  ```Kotlin
  unbindService(connection)
  ```

  서비스 생명주기   override fun onServiceConnected(name: ComponentName?, service: IBinder?) { } // bindService() 함수로 서비스를 구동할 때 자동으로 호출됨
    override fun onServiceDisconnected(name: ComponentName?) { } // unbindService() 함수로 서비스를 종료할 때 자동으로 호출됨
  }
  ```

  서비스 실행
  ```Kotlin
  val intent = Intent(this, MyService::class.java)
  bindService(intent, connection, Context.BIND_AUTO_CREATE)
  //    intent 객체 / ServiceConnection 객체 / Int 타입의 flags
  ```
    - `Context.BIND_AUTO_CREATE` : 서비스가 실행 상태가 아니어도 객체를 생성해서 실행
    - 지정하지 않으면 인텐트가 전달돼도 서비스가 실행 상태가 아니면 동작하지 않음

  서비스 종료
  ```Kotlin
  unbindService(connection)
  ```

  서비스 생명주기
  - `startService()`
    `onCreate()` -> `onStartCommand()` -> 서비스 실행 -> 스스로 혹은 클라이언트가 서비스 중단 -> `onDestroy()` -> 서비스 종료
  - `bindingService()`
    `onCreate()` -> `onBind()` -> 클라이언트를 서비스에 바인딩 -> 모든 클라이언트가 unbindService() 함수로 바인딩 해제 -> `onUnbind()` -> `onDestroy()` -> 서비스 종료

    - `onCreate()`는 서비스 객체가 생성될 때 처음 한 번만 호출됨

# 15-2 바인딩 서비스
## IBinder 객체 바인딩
- `startService` : 백그라운드 작업은 필요하지만 액티비티와 데이터를 주고받을 일이 없는 등 서로 관련이 없을 때 
- `bindService` : 서비스와 액티비티가 상호작용해야 할 때. 서비스가 실행되면서 자신을 실행한 곳에 객체를 바인딩함 (전달함) 서비스에서 넘어온 객체를 갖고 있다가 이 객체의 함수를 호출하여 데이터를 전달함

- 서비스 코드
```Kotlin
class MyBinder : Binder() {
  fun ...
}
override fun onBind(intent: Intent): IBinder? {
  return MyBinder()
}
```

- 액티비티 코드
```Kotlin
val connection: ServiceConnection = object : ServiceConneciton {
  override fun onServiceConnected(name: ComponentName?, service: IBinder?) {
    serviceBinder = service as MyService.MyBinder
  }
  override fun onServiceDisconnected(name: ComponentName?) {
  }
}
```

- AIDL 통신 기법
  - 두 프로세스 사이에 데이터를 주고받는 프로세스 간 통신을 구현할 때 사용하는 기법
  - `bindService()`를 사용함
  - 데이터를 시스템에 전달한 후에 시스템이 다른 프로세스에 전달해줘야 함
  - 시스템에 전달하는 데이터는 시스템이 해석할 수 있는 원시 타입으로 변환해야 하고, 전송하는 데 적합한 형식으로 변환하는 마샬링(`marshalling`)을 거쳐야 함
    -> build.gradle.kts에 AIDL을 사용하겠다고 선언해야 함
    ```Kotlin
    android {
      buildFeatures {
        aidl = true
      }
    }
    ```

- 서비스를 제공하는 앱
  - 외부 앱과 AIDL로 데이터를 주고받으면서 작업 처리
  - 확장자가 aidl인 파일을 만듦
  ```Kotlin
  interface MyAIDInterface {
    void funA(String data);
    int funB();
  }
  ```

  ```Kotlin
  Class MyAIDService : Service() {
    override fun onBind(intent : Intent) : IBinder {
      return object : MyAIDInterface.Stub() {
        override fun funA(data: String?) {
        }
        override fun funB() : Int {
          return 10
        }
      }
    }
  }
  ```

  - 외부 앱이 funA(), funB()를 호출할 때 이 서비스에서 구현한 함수가 실행됨
